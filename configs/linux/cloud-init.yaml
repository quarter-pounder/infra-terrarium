#cloud-config

hostname: ${hostname}
fqdn: ${hostname}.infra-terrarium.local

package_update: true
package_upgrade: false
packages:
  - curl
  - wget
  - gnupg
  - ca-certificates
  - chrony
  - unzip
  - net-tools

runcmd:
  # Enable NTP
  - systemctl enable chrony
  - systemctl start chrony

  # Local instance tags
  - echo "env=dev" >> /etc/environment
  - echo "role=core-linux" >> /etc/environment

  # Create Alloy directories
  - mkdir -p /etc/alloy /var/log/alloy

  # Download and install Alloy
  - curl -Lo /usr/local/bin/alloy https://github.com/grafana/alloy/releases/latest/download/alloy-linux-amd64
  - chmod +x /usr/local/bin/alloy

  # Write Alloy config file
  - |
    cat <<'ALLOYEOF' > /etc/alloy/config.alloy
    ${alloy_config}
    ALLOYEOF

  # Add systemd service
  - |
    cat <<EOF > /etc/systemd/system/alloy.service
    [Unit]
    Description=Grafana Alloy
    After=network.target

    [Service]
    ExecStart=/usr/local/bin/alloy --config.file=/etc/alloy/config.alloy
    Restart=always

    [Install]
    WantedBy=multi-user.target
    EOF

  - systemctl daemon-reexec
  - systemctl daemon-reload
  - systemctl enable alloy
  - systemctl start alloy

  # Log emitter: script + systemd timer (every 30s)
  - install -d -m 0755 /usr/local/bin
  - |
    cat <<'EMITTERSCRIPT' > /usr/local/bin/log-emitter.sh
    ${log_emitter_script}
    EMITTERSCRIPT
  - chmod +x /usr/local/bin/log-emitter.sh
  - touch /var/log/terrarium-emitter.log
  - chmod 644 /var/log/terrarium-emitter.log
  - |
    cat <<'EOF' > /etc/systemd/system/log-emitter.service
    [Unit]
    Description=Terrarium log emitter
    After=network.target

    [Service]
    Type=oneshot
    ExecStart=/usr/local/bin/log-emitter.sh
    EOF
  - |
    cat <<'EOF' > /etc/systemd/system/log-emitter.timer
    [Unit]
    Description=Run log emitter every 30s

    [Timer]
    OnBootSec=60
    OnUnitActiveSec=30
    Persistent=true

    [Install]
    WantedBy=timers.target
    EOF
  - systemctl daemon-reload
  - systemctl enable log-emitter.timer
  - systemctl start log-emitter.timer

  # Marker
  - echo "cloud-init complete: $(date)" >> /var/log/cloud-init-done.log

users:
  - name: ubuntu
    sudo: ALL=(ALL) NOPASSWD:ALL
    groups: users, admin
    shell: /bin/bash
    ssh_authorized_keys:
      - ${ssh_authorized_key}

final_message: "Terrarium cloud-init finished with Alloy installed."
